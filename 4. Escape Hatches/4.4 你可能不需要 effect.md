 
Effects æ˜¯ React èŒƒå¼ä¸­çš„ä¸€ä¸ªä¾‹å¤–ï¼Œå®ƒè®©ä½ èµ°å‡º React å¹¶å°†ä½ çš„ç»„ä»¶å’Œä¸€äº›å¤–éƒ¨ç³»ç»ŸåŒæ­¥ï¼Œæ¯”å¦‚é React ç»„ä»¶ã€ç½‘ç»œæˆ–æµè§ˆå™¨ DOMã€‚å¦‚æœä¸æ¶‰åŠå¤–éƒ¨ç³»ç»Ÿï¼ˆæ¯”å¦‚ï¼Œä½ æƒ³åœ¨æŸäº› props å’Œ state å˜åŒ–çš„æ—¶å€™æ›´æ–°ç»„ä»¶çš„ stateï¼‰ï¼Œåˆ™ä¸éœ€è¦ Effectã€‚åˆ é™¤ä¸å¿…è¦çš„ Effect å°†æ˜¯ä½ çš„ä»£ç æ›´å®¹æ˜“ç†è§£ã€è¿è¡Œé€Ÿåº¦æ›´å¿«ä¸”ä¸å®¹æ˜“å‡ºé”™ã€‚

> ä½ å°†å­¦åˆ°
> - ä¸ºä»€ä¹ˆè¦ä»ç»„ä»¶ä¸­åˆ é™¤ä¸å¿…è¦çš„ Effects åŠæ€ä¹ˆåš
> - å¦‚æœç¼“å­˜å¼€é”€æ˜‚è´µçš„è®¡ç®—
> - å¦‚ä½•åœ¨ä¸ä½¿ç”¨ Effects çš„æƒ…å†µä¸‹é‡ç½®å’Œè°ƒæ•´ç»„ä»¶ state
> - å¦‚ä½•åœ¨äº‹ä»¶å¤„ç†ç¨‹åºä¸­å…±äº«é€»è¾‘
> - å“ªäº›é€»è¾‘åº”è¯¥æ”¾åœ¨äº‹ä»¶å¤„ç†ç¨‹åºä¸­
> - å¦‚ä½•é€šçŸ¥çˆ¶ç»„ä»¶æ›´æ–°

## å¦‚ä½•ç§»é™¤ä¸å¿…è¦çš„ Effect

ä¸‹é¢æ˜¯ä¸¤ä¸ªå¸¸è§çš„ä¸éœ€è¦ Effects çš„ä¾‹å­:

- ä¸è¦ç”¨ Effect æ¥æ¸²æŸ“è½¬æ¢æ•°æ®ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ä½ æƒ³åœ¨æ˜¾ç¤ºåˆ—è¡¨å‰å…ˆè¿‡æ»¤å®ƒï¼Œä½ å¯èƒ½æƒ³å°è¯•å†™ä¸ª Effectï¼Œå½“åˆ—è¡¨å‘ç”Ÿå˜åŒ–æ—¶æ›´æ–° state å˜é‡ã€‚ç„¶è€Œè¿™æ˜¯æ— æ•ˆçš„ï¼Œå½“ä½ æ›´æ–° state çš„æ—¶å€™ï¼ŒReact ä¼šé¦–å…ˆè°ƒç”¨ä½ çš„ç»„ä»¶å‡½æ•°æ¥è®¡ç®—å‡ºåº”è¯¥æ˜¾ç¤ºä»€ä¹ˆï¼Œç„¶å React ä¼šå°†è¿™äº›å˜åŠ¨æäº¤ç»™ DOMï¼Œæ›´æ–°æ˜¾ç¤ºã€‚ç„¶å React è¿è¡Œä½ çš„ Effectï¼Œå¦‚æœä½ çš„ Effect ä¹Ÿæ›´æ–°äº† stateï¼Œè¿™ä¼šè®©æ•´ä¸ªå¤„ç†æµç¨‹ä»å¤´å†æ¥ä¸€æ¬¡ã€‚ä¸ºäº†é¿å…è¿™äº›æ— æ•ˆçš„æ¸²æŸ“æµç¨‹ï¼Œåœ¨ç»„ä»¶å†…éƒ¨æ¥è½¬æ¢æ•°æ®ï¼Œæ— è®ºä½•æ—¶ä½ çš„ props å’Œ state å˜åŒ–æ—¶ä»£ç éƒ½ä¼šè‡ªåŠ¨è¿è¡Œã€‚
- ä¸è¦ç”¨ Effect å¤„ç†ç”¨æˆ·äº‹ä»¶ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ç”¨æˆ·è´­ä¹°äº§å“æ—¶ä½ æƒ³å‘é€ä¸€ä¸ª /api/buy çš„ POST è¯·æ±‚å¹¶å±•ç¤ºæç¤ºä¿¡æ¯ï¼Œåœ¨è´­ä¹°æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ä¸­ï¼Œä½ å®Œå…¨çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆï¼›è€Œå½“ Effect è¿è¡Œæ—¶ï¼Œä½ ä¸çŸ¥é“ç”¨æˆ·å¹²äº†å•¥ï¼ˆæ¯”å¦‚ç‚¹å‡»äº†å“ªä¸ªæŒ‰é’®ï¼‰ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ éœ€è¦åœ¨å¯¹åº”çš„äº‹ä»¶å¤„ç†ç¨‹åºä¸­å¤„ç†ç”¨æˆ·äº‹ä»¶ã€‚

ä½ ç¡®å®éœ€è¦ Effects æ¥ä¸å¤–éƒ¨ç³»ç»ŸåŒæ­¥ï¼Œæ¯”å¦‚ï¼Œä½ å¯ä»¥å†™ä¸€ä¸ª Effect æ¥è®© Jquery ç»„ä»¶å’Œ React ç»„ä»¶ä¿æŒåŒæ­¥ã€‚ä½ è¿˜å¯ä»¥é€šè¿‡ Effect æ‹‰å–æ•°æ®ï¼šæ¯”å¦‚ä½ å¯ä»¥ç”¨å½“å‰æœç´¢æ¡ä»¶æ¥åŒæ­¥æœç´¢ç»“æœã€‚è®°ä½ï¼Œç°ä»£æ¡†æ¶æä¾›äº†æ¯”ç›´æ¥å†™åœ¨ç»„ä»¶çš„ Effect ä¸­çš„æ›´åŠ é«˜æ•ˆçš„å†…ç½®çš„æ•°æ®è·å–æœºåˆ¶ã€‚

ä¸ºäº†å¸®åŠ©ä½ è·å¾—æ­£ç¡®çš„ç›´è§‰ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€äº›å¸¸è§çš„å…·ä½“çš„ä¾‹å­

## åŸºäº props æˆ– state æ›´æ–° state

å‡è®¾ä½ æœ‰ä¸€ä¸ªç»„ä»¶ï¼Œå…¶æœ‰ä¸¤ä¸ª state: firstName å’Œ lastNameã€‚ä½ æƒ³é€šè¿‡æ‹¼æ¥å®ƒä»¬çš„æ–¹å¼è®¡ç®—å‡ºä¸€ä¸ª fullNameï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œæ— è®ºä½•æ—¶ firstName æˆ– lastName å˜åŒ–æ—¶ fullName ä¹Ÿéšä¹‹è€Œå˜ã€‚ä½ çš„ç¬¬ä¸€ç›´è§‰å¯èƒ½æ˜¯æ·»åŠ ä¸€ä¸ª fullName çš„ state å˜é‡ï¼Œç„¶ååœ¨ Effect ä¸­æ›´æ–°å®ƒï¼š

```javascript
function Form() {
  const [firstName, setFirstName] = useState('');
  const [lastName, setLastName] = setState('');
  const [fullName, setFullName] = setState('');

  useEffect(() => {
    setFullName(firstName + lastName);
  }, [firstName, lastName])
}
```

ç›¸å¯¹å¿…è¦æ€§æ¥è¯´ï¼Œè¿™è¦å¤æ‚çš„å¤šã€‚å®ƒè¿˜å¾ˆä½æ•ˆï¼šå®ƒç”¨è¿‡æ—¶çš„ fullName æ‰§è¡Œäº†æ•´ä¸ªæ¸²æŸ“è¿‡ç¨‹ï¼Œç„¶åé©¬ä¸Šç”¨æ›´æ–°åçš„å€¼å†æ¬¡æ‰§è¡Œæ¸²æŸ“ã€‚åˆ é™¤è¿™ä¸ª state å˜é‡å’Œ Effect:

```javascript
function Form() {
  const [firstName, setFirstName] = useState('');
  const [lastName, setLastName] = useState('');
  const fullName = firstName + lastName;
}
```

å½“æŸäº›å€¼å¯ä»¥é€šè¿‡å­˜åœ¨çš„ props æˆ– state è®¡ç®—å¾—åˆ°æ—¶ï¼Œä¸è¦å°†å…¶æ”¾å…¥ stateï¼Œè€Œæ˜¯åœ¨æ¸²æŸ“æœŸé—´è®¡ç®—å®ƒã€‚è¿™ä¼šè®©ä½ çš„ä»£ç æ›´å¿«ã€æ›´ç®€å•å¹¶ä¸”æ›´ä¸å®¹æ˜“å‡ºé”™ã€‚å¦‚æœä½ è§‰å¾—è¿™ç§æ–¹æ³•å¾ˆé™Œç”Ÿï¼Œè€ƒè™‘ React æ˜¯å¦‚ä½•è§£é‡Š state ä¸­åº”è¯¥æ”¾ä»€ä¹ˆçš„ã€‚

## ç¼“å­˜æ˜‚è´µçš„è®¡ç®—

è¿™ä¸ªç»„ä»¶é€šè¿‡æ¥å— prop ä¸­çš„ `todos` å’Œ `filter` æ¥è®¡ç®— `visibleTodos`ã€‚ä½ å¯èƒ½æƒ³å°è¯•åœ¨ state ä¸­å­˜å‚¨ç»“æœå¹¶åœ¨ Effect ä¸­æ›´æ–°å®ƒã€‚

```javascript

import { useState, useEffect } from 'react';

function TodoList({ todos, filter }) {
  const [newTodo, setNewTodo] = useState('');

  const [visibleTodos, setVisibleTodos] = useState([]);

  useEffect(() => {
    setVisibleTodos(getFilteredTodos(todos, filter))
  }, [todos, filter])
}
```

å’Œä¹‹å‰çš„ä¾‹å­ä¸€æ ·ï¼Œè¿™æ˜¯å¤šä½™ä¸”ä½æ•ˆçš„ã€‚é¦–å…ˆåˆ é™¤ state å’Œ Effect:

```javascript
funciton TodoList({ newTodo, setNewTodo}) {
  const visibleTodos = getFilteredTodos(todos, filter);
}
```

é€šå¸¸æ¥è¯´è¿™æ ·å°± ok äº†ï¼ä½†æ˜¯æˆ–è®¸ `getFilteredTodos()` æ¯”è¾ƒæ…¢æˆ–è€…ä½ æœ‰å¾ˆå¤šçš„ `todos`ã€‚è¿™ç§æƒ…å†µä¸‹å½“ä¸€äº›æ— å…³ state å˜é‡å˜åŒ–æ—¶(æ¯”å¦‚ newTodo)ï¼Œä½ å¯èƒ½ä¸æƒ³å†æ¬¡è®¡ç®— `getFilteredTodos()`.

ä½ å¯ä»¥å°†å…¶æ”¾å…¥ useMemo ä¸­æ¥ç¼“å­˜(è®°å¿†)æŸäº›æ˜‚è´µçš„è®¡ç®—:

```javascript
import {useMemo, useState} from 'react';

function TodoList({ todos, filter }) {
  const [newTodo, setNewTodo] = useState('');
  const vicibleTodos = useMemo(() => {
    return getFilteredTodos(todos, filter);
  }, [todos, filter])
}
```

è¿™ç­‰äºå‘Šè¯‰ React é™¤é todos æˆ– filter å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦åˆ™ä½ ä¸æƒ³è®©å†…éƒ¨çš„å‡½æ•°å†æ¬¡è¿è¡Œã€‚React ä¼šåœ¨é¦–æ¬¡æ¸²æŸ“æ—¶è®°ä½ getFilteredTodos() çš„è¿”å›å€¼ï¼Œåœ¨ä¸‹æ¬¡æ¸²æŸ“æ—¶ï¼Œå®ƒä¼šåˆ¤æ–­ todos å’Œ filter æ˜¯å¦å˜äº†ï¼Œå¦‚æœå’Œä¸Šæ¬¡æ¸²æŸ“æ—¶ä¸€è‡´ï¼ŒuseMemo ä¼šè¿”å›ä¸Šæ¬¡å­˜å‚¨çš„å€¼ï¼›ä½†æ˜¯å¦‚æœå‘ç”Ÿäº†å˜åŒ–ï¼ŒReact ä¼šå†æ¬¡è°ƒç”¨å†…éƒ¨å‡½æ•°(å¹¶å­˜å‚¨å…¶ç»“æœ)ï¼›

ä½ åŒ…åœ¨ useMemo çš„å‡½æ•°åœ¨æ¸²æŸ“æ—¶è¿è¡Œï¼Œæ‰€ä»¥ä»…é€‚ç”¨äºçº¯è®¡ç®—ã€‚

> æ·±åº¦é˜…è¯»
>
> å¦‚ä½•åˆ¤æ–­è®¡ç®—æ˜¯å¦æ˜‚è´µ
>
> é€šå¸¸æ¥è¯´ï¼Œé™¤éä½ åœ¨åˆ›å»ºæˆ–éå†æˆåƒä¸Šä¸‡çš„å¯¹è±¡ï¼Œå¦åˆ™å¼€é”€ä¸ç®—å¤§ã€‚å¦‚æœä½ æƒ³æ›´åŠ ç¡®å®šï¼Œå¯ä»¥ä¸ºå…¶æ·»åŠ æ§åˆ¶å°æ—¥å¿—æ¥æµ‹é‡è¿™æ®µä»£ç çš„æ‰§è¡Œæ—¶é—´
>
> ```javascript
> console.time('filter array');
> const visibleTodos = getFilteredTodos(todos, filter);
> console.timeEnd('filter array');
> ```
>
> æ‰§è¡Œä½ éœ€è¦æµ‹é‡çš„äº¤äº’ï¼Œç„¶åä½ å°†åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°ç±»ä¼¼ filter array: 0.15ms çš„æ—¥å¿—ã€‚å¦‚æœè®°å½•çš„æ€»æ—¶é—´åŠ èµ·æ¥å¾ˆå¤§ï¼ˆæ¯”å¦‚ 1ms æˆ–æ›´å¤šï¼‰ï¼Œé‚£ä¹ˆè®°ä½è®¡ç®—æ˜¯æœ‰æ„ä¹‰çš„ã€‚ä½œä¸ºä¸€ä¸ªå¯¹æ¯”ï¼Œä½ å¯ä»¥å°†è®¡ç®—åŒ…è£…åœ¨ useMemo ä¸­ä»¥äº¤å‰éªŒè¯äº¤äº’çš„æ€»æ—¶é—´æ˜¯å¦çœŸçš„å‡å°‘äº†.
>
> ```javascript
> console.time('filter array');
> const visibleTodos = useMemo(() => {
>   return getFilteredTodos(todos, filter);
> }, [todos, filter]);
> console.timeEnd('filter array');
> ```

> useMemo ä¸ä¼šè®©é¦–æ¬¡æ¸²æŸ“æ›´å¿«ï¼Œå®ƒåªä¼šå¸®ä½ åœ¨æ›´æ–°æ—¶è·³è¿‡æ— æ„ä¹‰çš„å·¥ä½œ
> æ³¨æ„ä½ çš„æœºå™¨å¯èƒ½æ¯”ä½ çš„ç”¨æˆ·æ›´å¿«ï¼Œæ‰€ä»¥è®¤ä¸ºé™ä½è®¡ç®—æœºæ€§èƒ½æ¥æµ‹è¯•æ€§èƒ½æ˜¯ä¸ªä¸é”™çš„æƒ³æ³•ï¼Œæ¯”å¦‚ chrome æä¾›äº† CPU Throttling é€‰é¡¹æ¥é™ä½ CPU æ€§èƒ½
> åŒæ ·ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸‹æµ‹è¯•æ€§èƒ½çš„ç»“æœå¯èƒ½ä¸å‡†ç¡®ã€‚è¦è·å¾—å‡†ç¡®çš„æ—¶é—´ï¼Œæ„å»ºç”Ÿäº§ç¯å¢ƒçš„åº”ç”¨å¹¶åœ¨ç”¨æˆ·æ‹¥æœ‰çš„è®¾å¤‡ä¸Šè¿›è¡Œæµ‹è¯•ã€‚

## å½“æŸä¸ª prop å˜åŒ–æ—¶é‡ç½®æ‰€æœ‰çš„ state

ä¸‹é¢çš„ ProfilePage ç»„ä»¶æ¥å—ä¸€ä¸ª userId propï¼Œé¡µé¢è¿˜åŒ…å«ä¸€ä¸ªè¯„è®ºè¾“å…¥æ¡†ï¼Œä½ ç”¨ä¸€ä¸ª comment çš„ state å˜é‡å­˜å‚¨å®ƒçš„å€¼ã€‚æœ‰å¤©ä½ å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼šå½“ä½ ä»ä¸€ä¸ª profile è·³è½¬åˆ°å¦ä¸€ä¸ª profile æ—¶ï¼Œcomment state ä¸ä¼šé‡ç½®ï¼Œå¾ˆå®¹æ˜“å¯¹é”™è¯¯çš„ç”¨æˆ·ä¿¡æ¯å‘è¡¨è¯„è®ºï¼Œä¸ºäº†ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œä½ å¸Œæœ›æ— è®ºä½•æ—¶ userId å˜åŒ–çš„æ—¶å€™å°±é‡ç½® comment

```javascript
import { useEffect, useState } from "react";

export default function ProfilePage({ userId }) {
  const [comment, setComment] = useState('');

  useEffect(() => {
    setComment('')
  }, [userId])
}
```

è¿™ç§å¤„ç†å¾ˆä½æ•ˆå› ä¸º ProfilePage å’Œå®ƒçš„ chldren é¦–å…ˆç”¨è¿‡æ—¶çš„å€¼æ¸²æŸ“ï¼Œç„¶åå†æ¬¡ç”¨æ–°å€¼æ¸²æŸ“ï¼›è€Œä¸”è¿™ç§å¤„ç†å¾ˆç¹çï¼Œä½ éœ€è¦åœ¨æ¯ä¸ª ProfilePage å†…éƒ¨çš„ç»„ä»¶åšç±»ä¼¼çš„äº‹ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœè¯„è®ºçš„ UI æ˜¯åµŒå¥—çš„ï¼Œä½ éœ€è¦æ¸…ç†æ‰åµŒå¥—çš„è¯„è®º stateã€‚

ç›¸åï¼Œä½ å¯ä»¥é€šè¿‡ profile ä¸€ä¸ªæ˜ç¡®çš„ key æ¥å‘Šè¯‰ Reactæ¯ä¸ªç”¨æˆ·çš„ Profile å®é™…ä¸Šæ˜¯ä¸ä¸€æ ·çš„ä¸œè¥¿ã€‚å°†ä½ çš„ç»„ä»¶æ‹†åˆ†ä¸ºä¸¤ä¸ªï¼Œå¹¶ç”¨å¤–éƒ¨çš„ç»„ä»¶ç»™å†…éƒ¨çš„ç»„ä»¶ä¼ é€’ä¸€ä¸ª key ä½œä¸ºå±æ€§

```javascript
export default function ProfilePage({ userId }) {
  return (
    <Profile userId={ userId } key={ userId }/>
  )
}
function Profile({ userId }) {
  const [comment, setComment] = useState('') // å½“ userId å˜åŒ–çš„æ—¶å€™ä¼šè‡ªåŠ¨é‡ç½®
}
```

é€šå¸¸æ¥è¯´ï¼Œå½“ React çœ‹åˆ°åŒæ ·çš„ç»„ä»¶å‡ºç°åœ¨åŒæ ·ä½ç½®æ—¶æ‰ä¼šä¿ç•™ stateï¼Œä¸º Profile ç»„ä»¶ä¼ é€’ userId ä½œä¸º keyï¼Œä½ è¦æ±‚ React å°†å…·æœ‰ä¸åŒ userId çš„ä¸¤ä¸ª Profile ç»„ä»¶è§†ä¸ºä¸¤ä¸ªä¸åº”è¯¥å…±äº« state çš„ç»„ä»¶ã€‚æ— è®ºä½•æ—¶ key å‘ç”Ÿäº†å˜åŒ–ï¼ŒReact ä¼šä¸º Profile åŠå…¶å­å…ƒç´ å†æ¬¡åˆ›å»º DOM å¹¶é‡ç½® stateã€‚ç°åœ¨å½“ä½ åœ¨ files ä¸­è·³è½¬æ—¶ comment å­—æ®µä¼šè¢«é‡ç½®

æ³¨æ„è¿™ä¸ªä¾‹å­ä¸­ï¼Œåªæœ‰å¤–éƒ¨çš„ ProfilePage ç»„ä»¶è¢«å¯¼å‡ºäº†ï¼Œå¹¶ä¸”å¯ä»¥è¢«é¡¹ç›®ä¸­çš„å…¶ä»–æ–‡ä»¶è®¿é—®ã€‚æ¸²æŸ“ ProfilePage çš„ç»„ä»¶å¹¶ä¸éœ€è¦ä¸ºå…¶ä¼ é€’ keyï¼šå®ƒä»¬ä¼ é€’ userId ä½œä¸ºä¸€ä¸ªå¸¸è§„å±æ€§ï¼ŒProfilePage å°†å…¶ä¼ é€’ç»™ Profile å¹¶ä½œä¸º key æ˜¯ä¸€ä¸ªå®ç°ç»†èŠ‚ã€‚

## å½“æŸä¸ª props å˜åŒ–æ—¶è°ƒæ•´ state

æŸä¸ª props å˜åŒ–æ—¶ï¼Œæœ‰æ—¶å€™ä½ å¯èƒ½åªæƒ³è°ƒæ•´æˆ–é‡ç½®éƒ¨åˆ† stateï¼Œè€Œä¸æ˜¯å…¨éƒ¨ã€‚

ä¸‹é¢çš„ List ç»„ä»¶æ¥å—ä¸€ç»„ items ä½œä¸º propï¼Œå¹¶åœ¨ state ä¸­æŒæœ‰ selection è¡¨ç¤ºé€‰ä¸­é¡¹ã€‚æ— è®ºä½•æ—¶å½“ items prop å˜ä¸ºä¸€ä¸ªæ–°æ•°ç»„æ—¶ï¼Œä½ å¸Œæœ›å°† selection é‡ç½®ä¸º null

```javascript
function List({ items }) {
  const [iseReverse, setIsReverse] = useState(false);
  const [selection, setSelection] = useState(null);

  useEffect(() => {
    setSelection(null)
  }, [items])
}
```

è¿™ä¹Ÿä¸ç†æƒ³ï¼Œæ¯æ¬¡ items å˜åŒ–æ—¶ï¼ŒList ç»„ä»¶åŠå­ç»„ä»¶éƒ½è¦é¦–å…ˆæ¸²æŸ“ä¸€ä¸ªè¿‡æ—¶çš„ selectionï¼Œç„¶å React æ›´æ–° DOM å¹¶è¿è¡Œ Effectsï¼Œæœ€ç»ˆ setSelection(null) ä¼šå¯¼è‡´ List ç»„ä»¶å†æ¬¡æ¸²æŸ“ï¼Œå¹¶é‡å¤è¿™ä¸ªæµç¨‹ã€‚

é¦–å…ˆåˆ é™¤ Effectï¼Œåœ¨æ¸²æŸ“æ—¶æ‰‹åŠ¨è°ƒæ•´ state

```javascript
import { useState } from "react";

function List({ items }) {
  const [isReverse, setIsReverse] = useState(false);
  const [selection, setSelection] = useState(null);

  const [prevItems, setPrevItems] = useState(items);

  if (items !== prevItems) {
    setPrevItems(items);
    setSelection(null);
  }
}
```

è¿™ç§ä¿å­˜ä¸Šæ¬¡ render ä¿¡æ¯çš„æ–¹æ³•å¾ˆéš¾ç†è§£ï¼Œä½†æ˜¯è¿™æ¯”åœ¨ effect ä¸­æ›´æ–°åŒä¸€ä¸ª state å¥½å¤šäº†ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒsetSelection åœ¨æ¸²æŸ“æœŸé—´è¢«ç›´æ¥è°ƒç”¨äº†ï¼ŒReact åœ¨çœ‹åˆ° return è¯­å¥åä¼šé©¬ä¸Šæ¸²æŸ“ Listï¼Œæ­¤æ—¶ React è¿˜æ²¡æœ‰æ¸²æŸ“ List çš„å­ç»„ä»¶æˆ–æ›´æ–° DOMï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼è®© List å­ç»„ä»¶ä¸ç”¨æ¸²æŸ“è¿‡æ—¶çš„ selection å€¼

å½“ä½ åœ¨æ¸²æŸ“æ—¶æ›´æ–°äº†ä¸€ä¸ªç»„ä»¶ï¼ŒReact ä¼šä¸¢å¼ƒè¿”å›çš„ JSX å¹¶é©¬ä¸Šé‡è¯•æ¸²æŸ“ã€‚ä¸ºäº†é¿å…å‡ºç°ç¼“æ…¢çš„çº§è”é‡è¯•ï¼ŒReact åªå…è®¸ä½ åœ¨æ¸²æŸ“æ—¶æ›´æ–°åŒä¸€ç»„ä»¶çš„ stateã€‚å¦‚æœä½ åœ¨æ¸²æŸ“æ—¶æ›´æ–°äº†å¦ä¸€ä¸ªç»„ä»¶çš„ stateï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ª errorã€‚ç±»ä¼¼ items !== prevItems çš„æ¡ä»¶æ˜¯å¿…è¦çš„ï¼Œé˜²æ­¢å‡ºç°æ­»å¾ªç¯ã€‚ä½ å¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹å¼è°ƒæ•´ stateï¼Œä½†æ˜¯å…¶ä»–çš„å‰¯ä½œç”¨åº”è¯¥è¢«æ”¾å…¥äº‹ä»¶å¤„ç†ç¨‹åºæˆ– Effect ä¸­ï¼Œä»¥ä¿æŒç»„ä»¶æ˜¯çº¯çš„

è™½ç„¶è¿™ç§æ–¹å¼æ¯” Effect æ›´åŠ é«˜æ•ˆï¼Œä½†æ˜¯å¤§å¤šæ•°ç»„ä»¶éƒ½ä¸åº”è¯¥ä½¿ç”¨å®ƒã€‚æ— è®ºä½ æ€ä¹ˆåšï¼ŒåŸºäºå…¶ä»–çš„ props æˆ– state è°ƒæ•´ state éƒ½ä¼šè®©ä½ çš„æ•°æ®æµå‘æ›´éš¾ç†è§£å’Œè°ƒè¯•ï¼Œé‡åˆ°ç±»ä¼¼çš„åœºæ™¯ï¼Œåº”è¯¥æ£€æŸ¥ä¸‹èƒ½å¦é€šè¿‡ä¸€ä¸ª key æ¥é‡ç½®æ‰€æœ‰çš„ state æˆ–åœ¨æ¸²æŸ“æœŸé—´è®¡ç®—ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸å…¶ä¿å­˜é€‰ä¸­é¡¹ï¼Œä¸å¦‚ä¿å­˜é€‰ä¸­çš„ id:

```javascript
function List({ items }) {
  const [isReverse, setIsReverse] = useState(false);
  const [selectedId, setSelectedId] = useState(null);
  const selection = items.find(item => item.id === selectedId) ?? null;
  // ...
}
```

ç°åœ¨æ ¹æœ¬ä¸éœ€è¦è°ƒæ•´ state äº†ï¼Œå¦‚æœåˆ—è¡¨ä¸­æœ‰é€‰ä¸­çš„ idï¼Œå®ƒå°†ç»§ç»­ä¿æŒé€‰ä¸­çŠ¶æ€ï¼›å¦‚æœæ²¡æœ‰ï¼Œæ¸²æŸ“æ—¶è®¡ç®—å‡ºçš„ section å°†æ˜¯ nullï¼Œå› ä¸ºåˆ—è¡¨å·²ç»æ²¡æœ‰åŒ¹é…çš„ item äº†ã€‚è¿™ç§è¡Œä¸ºæ˜¯ä¸åŒçš„ï¼Œä½†å¯ä»¥è¯´æ›´å¥½å› ä¸ºå³ä½¿ä¿®æ”¹äº† items çš„å¤šæ•°é¡¹ï¼Œå…¶é€‰ä¸­çŠ¶æ€éƒ½ä¼šä¿ç•™ã€‚

## ç»„ä»¶ä¹‹é—´å…±äº«é€»è¾‘

å‡è®¾ä½ æœ‰ä¸ªäº§å“é¡µï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªæŒ‰é’®ï¼ˆè´­ä¹°å’Œç»“è´¦ï¼‰éƒ½å…è®¸ä½ è´­ä¹°äº§å“ï¼Œä½ å¸Œæœ›ç”¨æˆ·å°†äº§å“æ”¾å…¥è´­ç‰©è½¦æ—¶å±•ç¤ºä¸€ä¸ªé€šçŸ¥ã€‚åœ¨ä¸¤ä¸ªæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ä¸­è°ƒç”¨ showNotification() æœ‰ç‚¹å†—ä½™ï¼Œæ‰€ä»¥ä½ è¯•ç€åœ¨ Effect ä¸­æ›¿æ¢è¿™æ®µé€»è¾‘:

```javascript
import { useEffect } from 'react';

function ProductPage({ product, addToCart }) {
  useEffect(() => {
    if (product.isInCart) {
      showNotification(`Added ${product.name} to the shopping cart!`);
    }
  }, [product]);

  function handleBuyClick() {
    addToCart(product)
  }

  function handleCheckoutClick() {
    addToCart(product);
    navigateTo('/checkout');
  }
}

```

è¿™ä¸ª Effect æ˜¯å¤šä½™çš„ï¼Œè¿˜å¯èƒ½ä¼šå¯¼è‡´ bugã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ä½ çš„åº”ç”¨åœ¨å¤šä¸ªé¡µé¢é—´ä¼šä¿å­˜è´­ç‰©è½¦ä¿¡æ¯ï¼Œå¦‚æœä½ ä¸ºè´­ç‰©è½¦æ·»åŠ äº†ä¸€ä¸ªäº§å“å¹¶åˆ·æ–°äº†é¡µé¢ï¼Œé€šçŸ¥ä¼šå†æ¬¡å±•ç¤ºï¼Œå¹¶ä¸”ä½ æ¯æ¬¡åˆ·æ–°é¡µé¢éƒ½ä¼šçœ‹åˆ°è¿™æ¡é€šçŸ¥ï¼Œè¿™æ˜¯å› ä¸º product.isInChart åœ¨é¡µé¢åŠ è½½æ—¶å·²ç»æ˜¯ true äº†ï¼Œæ‰€ä»¥ä¸Šé¢çš„ Effect ä¼šè°ƒç”¨ showNotification()

å½“ä½ ä¸ç¡®å®šæŸäº›é€»è¾‘åº”è¯¥åœ¨ Effect è¿˜æ˜¯äº‹ä»¶å¤„ç†å‡½æ•°ä¸­æ—¶ï¼Œé—®é—®è‡ªå·±è¿™æ®µä»£ç ä¸ºä»€ä¹ˆè¦è¿è¡Œï¼Ÿåªæœ‰é‚£äº›å› ä¸ºç»„ä»¶æœ¬èº«è¢«å±•ç¤ºç»™ç”¨æˆ·äº†æ‰åº”è¯¥è¿è¡Œçš„ä»£ç æ‰é€‚ç”¨äº Effectï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œåªæœ‰ç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ—¶æ‰åº”è¯¥å±•ç¤ºé€šçŸ¥ï¼Œè€Œä¸æ˜¯å› ä¸ºé¡µé¢è¢«æ˜¾ç¤ºäº†ï¼åˆ é™¤ Effect å¹¶å°†å…±äº«é€»è¾‘ç§»åŠ¨åˆ°ä¸€ä¸ªå‡½æ•°ä¸­ä»¥ä¾›äº‹ä»¶å¤„ç†å‡½æ•°è°ƒç”¨

```javascript
function ProductPage({ product, addToCart }) {
  function buyProduct() {
    addToCart(product);
    showNotification(`Added ${product.name} to the shopping cart!`);
  }

  function handleBuyClick() {
    buyProduct(product)
  }

  function handleCheckoutClick() {
    buyProduct()
    navigateTo('/checkout');
  }
}
```

è¿™ä¹ˆåšä¸ä½†åˆ é™¤äº†å¤šä½™çš„ Effect è€Œä¸”ä¿®å¤äº† bug

## å‘é€ä¸€ä¸ª POST è¯·æ±‚

ä¸‹é¢çš„ Form ç»„ä»¶å‘é€ä¸¤ç§ POST è¯·æ±‚ï¼Œå½“å…¶æŒ‚è½½æ—¶å‘é€ä¸€ä¸ªç»Ÿè®¡äº‹ä»¶ï¼›å½“ä½ å¡«å®Œè¡¨æ ¼å¹¶ç‚¹å‡»å‘é€æŒ‰é’®æ—¶ï¼Œå…¶å‘é€ä¸€ä¸ª POST è¯·æ±‚åˆ° /api/register

```javascript
function Form() {
  const [firstName, setFirstName] = useState('');
  const [lastName, setLastName] = useState('');

  useEffect(() => {
    post('/analytics/event', { eventName: 'visit_form' });
  }, []);

  const [jsonToSubmit, setJsonToSubmit] = useState(null);
  useEffect(() => {
    if (jsonToSubmit !== null) {
      post('/api/register', jsonToSubmit);
    }
  }, [jsonToSubmit]);

  function handleSubmit(e) {
    e.preventDefault();
    setJsonToSubmit({ firstName, lastName });
  }
  // ...
}
```

å†æ¬¡è€ƒè™‘ä¸Šä¸ªä¾‹å­ä¸­çš„æ ‡å‡†

ç»Ÿè®¡ POST è¯·æ±‚åº”è¯¥ä¿ç•™åœ¨ Effect ä¸­ï¼Œå› ä¸ºå‘é€ç»Ÿè®¡è¯·æ±‚çš„åŸå› æ˜¯è¡¨å•è¢«æ˜¾ç¤ºåœ¨å±å¹•ä¸Šäº†ã€‚

ç„¶è€Œå¦ä¸€ä¸ªè¯·æ±‚çš„åŸå› å¹¶ä¸æ˜¯è¡¨å•è¢«æ˜¾ç¤ºäº†ï¼Œä½ åªæƒ³åœ¨æŸä¸ªç¡®å®šçš„æ—¶é—´ç‚¹ä¸Šå‘é€è¯·æ±‚ â€”â€” å³ç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ—¶ã€‚å®ƒåªåº”è¯¥å‘ç”Ÿåœ¨æŸä¸ªç¡®å®šçš„äº¤äº’ä¸Šï¼Œåˆ é™¤ç¬¬äºŒä¸ª Effect å¹¶å°† POST è¯·æ±‚ç§»å…¥äº‹ä»¶å¤„ç†ç¨‹åº

```javascript
function Form() {
  const [firstName, setFirstName] = useState('');
  const [lastName, setLastName] = useState('');

  // âœ… Good: This logic runs because the component was displayed
  useEffect(() => {
    post('/analytics/event', { eventName: 'visit_form' });
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    // âœ… Good: Event-specific logic is in the event handler
    post('/api/register', { firstName, lastName });
  }
  // ...
}
```

å½“ä½ é€‰æ‹©åº”è¯¥å°†æŸäº›é€»è¾‘æ”¾å…¥äº‹ä»¶å¤„ç†å‡½æ•°è¿˜æ˜¯ Effect æ—¶ï¼Œæ ¸å¿ƒé—®é¢˜åœ¨äºä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹å®ƒåˆ°åº•æ˜¯å“ªä¸€ç§é€»è¾‘ï¼šå¦‚æœå®ƒæ˜¯ç”±æŸä¸ªç‰¹å®šçš„ç”¨æˆ·äº¤äº’å¯¼è‡´çš„ï¼Œåˆ™å°†å…¶æ”¾å…¥äº‹ä»¶å¤„ç†å‡½æ•°ï¼›å¦‚æœå®ƒæ˜¯ç”±äºç»„ä»¶å‡ºç°åœ¨å±å¹•ä¸Šå¯¼è‡´çš„ï¼Œå°†å…¶æ”¾å…¥ Effectã€‚

### è¿ç»­è®¡ç®—

æœ‰æ—¶å€™ä½ å¯èƒ½å°è¯•å®ç° Effect é“¾ï¼Œæ¯ä¸ª Effect åŸºäºå…¶ä»– state ä¿®æ”¹ state

```javascript
function Game() {
  const [card, setCard] = useState(null);
  const [goldCardCount, setGoldCardCount] = useState(0);
  const [round, setRound] = useState(1);
  const [isGameOver, setIsGameOver] = useState(false);

  // ğŸ”´ Avoid: Chains of Effects that adjust the state solely to trigger each other
  useEffect(() => {
    if (card !== null && card.gold) {
      setGoldCardCount(c => c + 1);
    }
  }, [card]);

  useEffect(() => {
    if (goldCardCount > 3) {
      setRound(r => r + 1)
      setGoldCardCount(0);
    }
  }, [goldCardCount]);

  useEffect(() => {
    if (round > 5) {
      setIsGameOver(true);
    }
  }, [round]);

  useEffect(() => {
    alert('Good game!');
  }, [isGameOver]);

  function handlePlaceCard(nextCard) {
    if (isGameOver) {
      throw Error('Game already ended.');
    } else {
      setCard(nextCard);
    }
  }
```

è¿™æ®µä»£ç æœ‰ä¸¤ä¸ªé—®é¢˜:

ä¸€ä¸ªé—®é¢˜åœ¨äºè¿™ç§æ–¹å¼æ•ˆç‡å¾ˆä½ï¼Œç»„ä»¶å¿…é¡»åœ¨æ¯æ¬¡ set å‡½æ•°è°ƒç”¨åé‡æ–°æ¸²æŸ“ï¼Œä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæœ€ååœºæ™¯ä¸‹(setCart -> render -> setGoldCardCount -> render -> setRount -> render -> setIsGameOver -> render)ä¼šå‘ç”Ÿä¸‰æ¬¡å¤šä½™çš„é‡æ–°æ¸²æŸ“

å°±ç®—å®ƒçœŸçš„å¾ˆå¿«ï¼Œéšç€ä»£ç çš„å‘å±•ï¼Œä½ ä¹Ÿä¼šå‘ç° effect é“¾ä¸ç¬¦åˆéœ€æ±‚ã€‚å‡è®¾ä½ è¦æ·»åŠ ä¸€ç§æ–¹å¼æ¥è¿½è¸ªæ¸¸æˆçš„å†å²ç§»åŠ¨è®°å½•ï¼Œä½ éœ€è¦å°†æ¯ä¸ª state å˜é‡å˜æ›´ä¸ºå…¶å†å²è®°å½•ã€‚ç„¶è€Œï¼Œå¯¹ card çš„ä¿®æ”¹ä¼šè§¦å‘ Effect é“¾å¹¶ä¿®æ”¹ä½ çœ‹åˆ°çš„æ•°æ®ï¼Œè¿™ç§ä»£ç å¾ˆè„†å¼±ã€‚

è¿™ç§æ¡ˆä¾‹åœ¨æ¸²æŸ“æ—¶è®¡ç®—æ‰€éœ€æ˜¯ä¸ªæ›´å¥½çš„é€‰æ‹©ï¼Œç„¶åäº‹ä»¶å¤„ç†å‡½æ•°ä¸­è°ƒæ•´ state

```javascript
import { useEffeft, useState } from 'react';

function Game() {
  const [card, setCard] = useState(null);
  const [goldCardCount, setGoldCardCount] = useState(0);
  const [round, setRount] = useState(1);

  const isGameover = round > 5; // æ¸²æŸ“æ—¶è®¡ç®—

  function handlePlaceCard(nextCard) {
    if (isGameover) {
      throw Error('Game already ended.');
    }
    setCard(nextCard);
    if (nextCard.gold) {
      if (goldCardCount <= 3) {
        setGoldCardCount(goldCardCount + 1);
      } else {
        setGoldCardCount(0);
        setRount(round + 1);
        if (round === 5) {
          alert('good game')
        }
      }
    }
  }
}
```

è¿™ç§æ–¹å¼æ•ˆç‡é«˜å¤šäº†ï¼Œå¦‚æœä½ æƒ³å®ç°ä¸€ä¸ªæŸ¥çœ‹æ¸¸æˆå†å²çš„æ–¹å¼ï¼Œä½ å¯ä»¥å°†å…¶ä¿®æ”¹ä¸ºè¿‡å»çš„æŸä¸ªå€¼è€Œæ— éœ€è§¦å‘ Effect é“¾ä»è€Œè°ƒæ•´åˆ°æ¯ä¸ªå€¼ã€‚å¦‚æœä½ æƒ³åœ¨å¤šä¸ªäº‹ä»¶å¤„ç†ç¨‹åºä¸­å¤ç”¨é€»è¾‘ï¼Œä½ å¯ä»¥åˆ†ç¦»å‡½æ•°å¹¶åœ¨è¿™äº›äº‹ä»¶å¤„ç†ç¨‹åºä¸­è°ƒç”¨å®ƒ

è®°ä½åœ¨äº‹ä»¶å¤„ç†ç¨‹åºå†…éƒ¨ï¼Œstate çš„è¡Œä¸ºå°±åƒå¿«ç…§ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå³ä½¿åœ¨ä½ è°ƒç”¨ `setRound(round + 1)` åï¼Œ`round` å˜é‡ä»ç„¶è¡¨ç¤ºç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ—¶çš„å€¼ã€‚å¦‚æœä½ è¦ä½¿ç”¨å®ƒçš„æœ€æ–°å€¼æ¥è®¡ç®—ï¼Œé‚£å°±åƒ `const nextRound = round + 1` ä¸€æ ·æ‰‹åŠ¨å®šä¹‰å®ƒ

æœ‰æ—¶å€™åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­ä½ æ— æ³•è®¡ç®—å‡ºä¸‹ä¸€ä¸ª stateï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æŸä¸ªè¡¨å•å…·æœ‰å¤šä¸ªä¸‹æ‹‰æ¡†ï¼Œåé¢çš„ä¸‹æ‹‰æ¡†çš„é€‰é¡¹æ˜¯æ ¹æ®å‰ä¸€ä¸ªä¸‹æ‹‰æ¡†çš„é€‰ä¸­å€¼è€Œå˜åŒ–çš„ï¼Œè¿™æ—¶ä¸€ä¸ª Effects é“¾æ˜¯åˆé€‚çš„ï¼Œå› ä¸ºä½ éœ€è¦å’Œç½‘ç»œè¯·æ±‚åŒæ­¥ã€‚

## åˆå§‹åŒ–åº”ç”¨

å½“åº”ç”¨åŠ è½½æ—¶æŸäº›é€»è¾‘åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚

ä½ æˆ–è®¸ä¼šå°è¯•å°†å…¶æ”¾å…¥ç»„ä»¶å†…çš„é¡¶çº§çš„ Effect ä¸­

```javascript
function App() {
  useEffect(() => {
    loadDataFromLocalStorage();
    checkAuthToken();
  }, [])
}
```

ç„¶è€Œä½ ä¼šå‘ç°å¼€å‘ç¯å¢ƒä¸‹å®ƒä¼šè¿è¡Œä¸¤æ¬¡ï¼Œè¿™ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ â€”â€” æ¯”å¦‚å®ƒä¼šå¯¼è‡´ token æ— æ•ˆï¼Œå› ä¸ºç”¨æˆ·å‡­è¯å¯èƒ½ä¼šæ— æ•ˆã€‚é€šå¸¸æ¥è¯´ï¼Œä½ çš„ç»„ä»¶åº”è¯¥éƒ½èƒ½é€‚åº”äºŒæ¬¡æŒ‚è½½ï¼Œè¿™åŒ…æ‹¬äº†ä½ çš„é¡¶çº§ App ç»„ä»¶

è™½ç„¶ç”Ÿäº§ç¯å¢ƒä¸‹å®é™…ä¸Šä¸ä¼šå‘ç”ŸäºŒæ¬¡æŒ‚è½½ï¼Œä½†æ˜¯åœ¨æ‰€æœ‰çš„ç»„ä»¶ä¸­éµå¾ªåŒæ ·çš„é™åˆ¶ä¼šè®©ä»£ç æ›´å®¹æ˜“å¤ç”¨å’Œç§»åŠ¨ã€‚å¦‚æœæŸäº›ä»£ç åªä¼šåœ¨æ¯æ¬¡åº”ç”¨åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡è€Œä¸æ˜¯æ¯æ¬¡ç»„ä»¶åŠ è½½ï¼Œé‚£å°±ä¸ºå…¶æ·»åŠ ä¸€ä¸ªé¡¶çº§ä½œç”¨åŸŸçš„å˜é‡æ¥åˆ¤æ–­æ˜¯å¦æ‰§è¡Œ

```javascript
let didInit = false;
function App() {
  useEffect(() => {
    if (!didInit) {
      didInit = true;
      // âœ… Only runs once per app load
      loadDataFromLocalStorage();
      checkAuthToken();
    }
  }, []);
  // ...
}
```

ä½ è¿˜å¯ä»¥åœ¨æ¨¡å—åˆå§‹åŒ–ä¹‹åï¼Œapp render å‰è¿è¡Œå®ƒ

```javascript
if (typeof window !== 'undefined') {
  checkAuthToken();
  loadDataFromLocalStorage();
}
function App() {
  // ...
}
```

å½“ä½ çš„ç»„ä»¶è¢«å¼•å…¥æ—¶ï¼Œé¡¶çº§ä½œç”¨åŸŸä»£ç æ‰§è¡Œäº†ä¸€æ¬¡ â€”â€” å³ä½¿æœ€ç»ˆå®ƒæ²¡æœ‰è¢«æ¸²æŸ“ã€‚ä¸ºé¿å…åœ¨å¯¼å…¥ä»»æ„ç»„ä»¶æ—¶é€Ÿåº¦å˜æ…¢æˆ–å‡ºç°æ„å¤–è¡Œä¸ºï¼Œè¯·ä¸è¦è¿‡åº¦ä½¿ç”¨æ­¤æ¨¡å¼ã€‚å°†åº”ç”¨ç¨‹åºèŒƒå›´å†…çš„åˆå§‹åŒ–é€»è¾‘ä¿ç•™çš„ App.js ç­‰æ ¹ç»„ä»¶æ¨¡å—æˆ–åº”ç”¨ç¨‹åºçš„å…¥å£ã€‚

## é€šçŸ¥çˆ¶ç»„ä»¶ state å˜åŒ–

å‡è®¾ä½ åœ¨å†™ä¸€ä¸ª `Toggle` ç»„ä»¶ï¼Œå…¶å†…éƒ¨æœ‰ä¸ª `isOn` çš„ stateï¼Œå€¼ä¸º `true` æˆ– `false`ã€‚æœ‰å¾ˆå¤šç§æ–¹å¼å¯ä»¥åˆ‡æ¢å®ƒ(ç‚¹å‡»æˆ–æ‹–æ‹½)ã€‚ä½ æƒ³åœ¨ `Toggle` å†…éƒ¨çš„ `state` å˜åŒ–æ—¶é€šçŸ¥çˆ¶ç»„ä»¶ï¼Œæ‰€ä»¥ä½ æš´éœ²äº†ä¸€ä¸ª `onChange` çš„äº‹ä»¶å¹¶åœ¨ Effect ä¸­è°ƒç”¨å®ƒ:

```javascript
import { useEffect, useState } from 'react';

function Toggle({ onChange }) {
  const [isOn, setIsOn] = useState(false);

  useEffect(() => {
    onChange(isOn);
  }, [isOn, onChange])

  function handleClick() {
    setIsOn(!isOn);
  }

  function handleDragEnd(e) {
    if (isCloserToRightEdge(e)) {
      setIsOn(true);
    } else {
      setIsOn(false);
    }
  }
  // ...
}
```

å’Œä¹‹å‰ä¸€æ ·ï¼Œè¿™ç§æ–¹å¼ä¸å¤ªç†æƒ³ã€‚é¦–å…ˆ `Toggle` ç»„ä»¶æ›´æ–°äº†å®ƒçš„ `state`ï¼Œç„¶å React æ›´æ–°äº†å±å¹•æ˜¾ç¤ºã€‚ç„¶å React è¿è¡Œ Effectï¼Œè°ƒç”¨çˆ¶ç»„ä»¶ä¼ é€’çš„ `onChange` å‡½æ•°ã€‚ç„¶åçˆ¶ç»„ä»¶ä¼šæ›´æ–°å®ƒçš„ stateï¼Œå¼€å§‹å¦ä¸€ä¸ªæ¸²æŸ“ã€‚ä¸€æ¬¡å®Œæˆæ‰€æœ‰äº‹æƒ…ä¼šæ›´å¥½

åˆ é™¤ Effect å¹¶ç”¨åŒä¸€ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°æ›´æ–°æ‰€æœ‰ç»„ä»¶çš„ state

```javascript
import { useEffect, useState } from 'react';

function Toggle({ onChange }) {
  const [isOn, setIsOn] = useState(false);

  function updateToggle(nextIsOn) {
    setIsOn(nextIsOn);
    onChange(nextIsOn);
  }

  function handleClick() {
    updateToggle(!isOn);
  }

  function handleDragEnd(e) {
    if (isCloserToRightEdge(e)) {
      updateToggle(true);
    } else {
      updateToggle(false);
    }
  }
  // ...
}
```

ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œ`Toggle` ç»„ä»¶åŠå…¶çˆ¶ç»„ä»¶éƒ½ä¼šåœ¨äº‹ä»¶ä¸­æ›´æ–°ä»–ä»¬çš„ stateã€‚React ä¼šä»å¤šä¸ªç»„ä»¶ä¸­é›†ä¸­æ‰¹é‡æ›´æ–°ï¼Œæ‰€ä»¥æ¸²æŸ“è¿‡ç¨‹åªæœ‰ä¸€æ­¥ã€‚

ä½ è¿˜å¯ä»¥å°† `state` æ”¾åˆ°ä¸€èµ·ï¼Œå¹¶ä»çˆ¶ç»„ä»¶ä¸­æ¥å— `isOn`:

```javascript
function Toggle({ isOn, onChange }) {
  function handleClick() {
    onChange(!isOn);
  }

  function handleDragEnd(e) {
    if (isCloserToRightEdge(e)) {
      onChange(true);
    } else {
      onChange(false);
    }
  }

  // ...
}
```

state æå‡å…è®¸çˆ¶ç»„ä»¶åˆ‡æ¢å…¶è‡ªèº«çš„ state æ¥å®Œå…¨æ§åˆ¶ `Toggle` ç»„ä»¶ï¼Œè¿™æ„å‘³ç€çˆ¶ç»„ä»¶å¿…é¡»åŒ…å«æ›´å¤šçš„é€»è¾‘ï¼Œä½†æ˜¯æ€»ä½“çš„ state ä¼šæ›´å°‘ã€‚æ¯å½“ä½ æƒ³è®©ä¸¤ä¸ªä¸åŒçš„ state å˜é‡ä¿æŒåŒæ­¥æ—¶ï¼Œè¯·å°è¯• state æå‡ã€‚

## å‘çˆ¶ç»„ä»¶ä¼ é€’æ•°æ®

ä¸‹é¢çš„ `Child` ç»„ä»¶æ‹‰å–äº†éƒ¨åˆ†æ•°æ®å¹¶åœ¨ Effect ä¸­ä¼ é€’ç»™ `Parent` ç»„ä»¶:

```javascript
function Parent() {
  const [data, setData] = useState(null);
  // ...
  return <Child onFetched={setData} />;
}

function Child({ onFetched }) {
  const data = useSomeAPI();
  // ğŸ”´ Avoid: Passing data to the parent in an Effect
  useEffect(() => {
    if (data) {
      onFetched(data);
    }
  }, [onFetched, data]);
  // ...
}
```

åœ¨ React ä¸­ï¼Œæ•°æ®ä»çˆ¶ç»„ä»¶æµå‘å­ç»„ä»¶ã€‚å½“ä½ çœ‹åˆ°å±å¹•ä¸Šå‡ºç°é—®é¢˜æ—¶ï¼Œä½ å¯ä»¥æ²¿ç€æŠ¥é”™ä¿¡æ¯çš„ç»„ä»¶å‘ä¸ŠæŸ¥æ‰¾ç›´åˆ°å‘ç°å…·æœ‰é”™è¯¯ state æˆ–ä¼ é”™ prop çš„ç»„ä»¶ã€‚å½“å­ç»„ä»¶åœ¨ Effect ä¸­æ›´æ–°çˆ¶ç»„ä»¶çš„ state æ—¶ï¼Œæ•°æ®æµå‘å¾ˆéš¾è¢«è¿½è¸ªã€‚ç”±äºçˆ¶ç»„ä»¶å’Œå­ç»„ä»¶éœ€è¦ç›¸åŒçš„æ•°æ®ï¼Œé‚£å°±è®©çˆ¶ç»„ä»¶æ‹‰å–æ•°ç»„å¹¶ä¼ é€’ç»™å­ç»„ä»¶:

```javascript
function Parent() {
  const data = useSomeAPI();
  // ...
  // âœ… Good: Passing data down to the child
  return <Child data={data} />;
}

function Child({ data }) {
  // ...
}
```

è¿™ä¹ˆåšæ›´ç®€å•ï¼Œå¹¶ä¸”ä¿æŒäº†æ•°æ®æµçš„å¯é¢„æµ‹æ€§: æ•°æ®æ€»æ˜¯ä»çˆ¶ç»„ä»¶æµå‘å­ç»„ä»¶

## è®¢é˜…å¤–éƒ¨ store

æœ‰æ—¶å€™ä½ çš„ç»„ä»¶å¯èƒ½éœ€è¦è®¢é˜…æŸäº› React state ä¹‹å¤–çš„æ•°æ®ï¼Œè¿™å¯èƒ½æºäºç¬¬ä¸‰æ–¹åº“æˆ–æ˜¯æŸä¸ªå†…ç½®çš„æµè§ˆå™¨ APIã€‚ç”±äºè¿™äº›æ•°æ®å¯ä»¥åœ¨ React ä¸çŸ¥é“çš„æƒ…å†µä¸‹å˜åŒ–ï¼Œæ‰€ä»¥ä½ éœ€è¦çš„ä¸ºç»„ä»¶æ·»åŠ è®¢é˜…ã€‚è¿™é€šå¸¸æ˜¯ç”± Effect å®Œæˆçš„ï¼Œä¸¾ä¸ªä¾‹å­:

```javascript
function useOnlineStatus() {
  // Not ideal: Manual store subscription in an Effect
  const [isOnline, setIsOnline] = useState(true);
  useEffect(() => {
    function updateState() {
      setIsOnline(navigator.onLine);
    }

    updateState();

    window.addEventListener('online', updateState);
    window.addEventListener('offline', updateState);
    return () => {
      window.removeEventListener('online', updateState);
      window.removeEventListener('offline', updateState);
    };
  }, []);
  return isOnline;
}

function ChatIndicator() {
  const isOnline = useOnlineStatus();
  // ...
}
```

è¿™é‡Œç»„ä»¶è®¢é˜…ä¸€ä¸ªå¤–éƒ¨çš„æ•°æ®æº(è¿™ä¸ªä¾‹å­ä¸­æ˜¯ `navigator.onLine` API)ã€‚ç”±äºè¿™ä¸ª API åœ¨æœåŠ¡å™¨ä¸Šä¸å­˜åœ¨ï¼Œæ‰€ä»¥åˆå§‹å€¼ä¸º `true`ã€‚æ— è®ºä½•æ—¶æµè§ˆå™¨ä¸­çš„å€¼å˜äº†ï¼Œç»„ä»¶éƒ½ä¼šæ›´æ–°å®ƒçš„ stateã€‚

å°½ç®¡ä¸ºæ­¤ä½¿ç”¨ Effect å¾ˆå¸¸è§ï¼Œä½†æ˜¯ React æœ‰ä¸€ä¸ªä¸“é—¨å†…ç½®çš„ Hook ç”¨äºè®¢é˜…å¤–éƒ¨çš„æ•°æ®æºï¼Œåˆ é™¤è¿™ä¸ª Effect å¹¶å°†å…¶æ›¿æ¢ä¸º `useSyncExternalStore()`:

```javascript
function subscribe(callback) {
  window.addEventListener('online', callback);
  window.addEventListener('offline', callback);
  return () => {
    window.removeListener('online', callback);
    window.removeListener('offline', callback);
  }
}
function useOnlineStatus() {
  return useSyncExternalStore(
    subscribe, 
    () => navagator.onLine, 
    () => true
  )
}
function ChatIndicator() {
  const isOnline = useOnlineStatus();
  // ...
}
```

ä¸ä½¿ç”¨ Effect æ‰‹åŠ¨å°†å¯å˜æ•°æ®åŒæ­¥åˆ° React state ç›¸æ¯”ï¼Œè¿™ç§æ–¹å¼æ›´ä¸å®¹æ˜“å‡ºé”™ã€‚é€šå¸¸ï¼Œä½ å°†ç¼–å†™ä¸€ä¸ªåƒä¸Šé¢ `useOnlineStatus` ä¸€æ ·çš„è‡ªå®šä¹‰ Hookï¼Œ è¿™æ ·ä½ å°±ä¸ç”¨åœ¨å¤šä¸ªç»„ä»¶ä¸­é‡å¤æ­¤ä»£ç äº†ã€‚åœ¨ [useSyncExternalStore](https://react.dev/reference/react/useSyncExternalStore)ä¸­é˜…è¯»æ›´å¤šå…³äºè®¢é˜…å¤–éƒ¨æ•°æ®æºçš„ä¿¡æ¯ã€‚

## æ‹‰å–æ•°æ®

å¾ˆå¤šåº”ç”¨é€šè¿‡ Effects æ¥æ‹‰å–æ•°æ®ï¼Œä¸‹é¢çš„è¿™ç§æ‹‰å–æ•°æ®çš„ Effect æ˜¯å¾ˆå¸¸è§çš„:

```javascript
import { useEffect, useState } from 'react';

function SearchResult({ query }) {
  const [result, setResults] = useState([]);
  const [page, setPage] = useState(1);

  useEffect(() => {
    fetchResults(query, page).then(json => {
      setResults(json)
    })
  }, [query, page])

  function handleNextPageClick() {
    setPage(page + 1);
  }
}
```

ä½ ä¸ç”¨æŠŠè¿™æ®µä»£ç ç§»åŠ¨åˆ°äº‹ä»¶å¤„ç†å‡½æ•°ä¸­ã€‚

è¿™ä¼¼ä¹ä¸ä¹‹å‰çš„éœ€è¦å°†é€»è¾‘æ”¾å…¥äº‹ä»¶å¤„ç†ç¨‹åºçš„ç¤ºä¾‹ç›¸çŸ›ç›¾ï¼ä½†æ˜¯è€ƒè™‘åˆ°æ‹‰å–æ•°æ®çš„ä¸»è¦åŸå› å¹¶ä¸æ˜¯è¾“å…¥äº‹ä»¶ï¼Œæœç´¢è¾“å…¥é€šå¸¸æ˜¯ä» URL ä¸­é¢„å¡«å……çš„ï¼Œå¹¶ä¸”ç”¨æˆ·å¯èƒ½åœ¨æ²¡æœ‰ç¢°è¾“å…¥æ¡†çš„æƒ…å†µä¸‹å‘å‰å’Œå‘åå¯¼èˆªã€‚

`page` å’Œ `query` æºè‡ªå“ªé‡Œå¹¶ä¸é‡è¦ï¼Œå½“æ­¤ç»„ä»¶å¯è§æ—¶ï¼Œä½ å¸Œæœ› `results` æ˜¯å’Œç”¨å½“å‰ `page`ã€`query` æŸ¥è¯¢çš„æ•°æ®åŒ¹é…çš„ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒæ˜¯ Effect çš„åŸå› ã€‚

ç„¶è€Œä¸Šé¢çš„ä»£ç æœ‰ä¸ª bugã€‚å‡è®¾ä½ å¿«é€Ÿè¾“å…¥ "hello"ï¼Œç„¶å `query` ä¼šä» h å˜æˆ he,hel,hell,helloï¼Œè¿™ä¼šå¯¼è‡´å¤šä¸ªè¯·æ±‚ï¼Œä½†æ˜¯å“åº”çš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ã€‚æ¯”å¦‚ï¼Œ"hell" çš„å“åº”å¯èƒ½æ¯” "hello" è¦æ™šï¼Œç”±äºå®ƒæœ€ç»ˆä¼šè°ƒç”¨ `setResults()`ï¼Œæ‰€ä»¥æœ€ç»ˆä½ çœ‹åˆ°çš„æœç´¢ç»“æœå¯èƒ½æ˜¯é”™çš„ã€‚è¿™ç§æƒ…å†µè¢«æˆä¸º â€œç«æ€â€ï¼šä¸¤ä¸ªä¸åŒçš„è¯·æ±‚ç›¸äº’ç«äº‰å¹¶ä»¥å’Œä½ é¢„æœŸä¸åŒçš„é¡ºåºå‡ºç°ã€‚

è¦ä¿®å¤è¿™ä¸ªç«æ€é—®é¢˜ï¼Œä½ éœ€è¦æ·»åŠ ä¸€ä¸ªæ¸…ç†å‡½æ•°æ¥å¿½ç•¥è¿‡æ—¶çš„å“åº”:

```javascript
import { useEffect, useState } from 'react';

function SearchResult({ query }) {
  const [result, setResults] = useState([]);
  const [page, setPage] = useState(1);

  useEffect(() => {
    let ignore = false;
    fetchResults(query, page).then(json => {
      if (!ignore) {
        setResults(json)
      }
    })
    return () => {
      ignore = true;
    }
  }, [query, page])

  function handleNextPageClick() {
    setPage(page + 1);
  }
}
```

è¿™ä¿è¯äº†å½“ä½ çš„ Effect æ‹‰å–æ•°æ®åï¼Œé™¤æœ€åä¸€ä¸ªè¯·æ±‚ä¹‹å¤–çš„å“åº”ç»“æœéƒ½ä¼šè¢«å¿½ç•¥ã€‚

å¤„ç†ç«æ€é—®é¢˜å¹¶ä¸æ˜¯å®ç°æ•°æ®æ‹‰å–çš„å”¯ä¸€éš¾ç‚¹ï¼Œä½ å¯èƒ½è¿˜è¦è€ƒè™‘å¦‚ä½•ç¼“å­˜å“åº”ç»“æœ(ä»¥ä¾¿ç”¨æˆ·åé€€æ—¶èƒ½é©¬ä¸Šçœ‹åˆ°ä¹‹å‰çš„å†…å®¹)ï¼Œå¦‚ä½•ä»æœåŠ¡å™¨ä¸Šæ‹‰å–æ•°æ®ï¼ˆä»¥ä¾¿é¦–å±æ¸²æŸ“åŒ…å«å†…å®¹è€Œä¸åªæ˜¯ loadingï¼‰ï¼ŒåŠå¦‚ä½•é¿å…ç½‘ç»œè¯·æ±‚ç€‘å¸ƒï¼ˆè¿™æ ·å­ç»„ä»¶å°±å¯ä»¥åœ¨ä¸ç”¨ç­‰çˆ¶ç»„ä»¶è¯·æ±‚åå†è¯·æ±‚äº†ï¼‰

è¿™äº›é—®é¢˜å‡ºç°åœ¨æ‰€æœ‰çš„ UI åº“ä¸Šï¼Œè€Œä¸åªæ˜¯ Reactã€‚è§£å†³å®ƒä»¬å¹¶éæ˜“äº‹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆç°ä»£æ¡†æ¶æä¾›äº†æ¯”åœ¨ Effect ä¸­æ‹‰å–æ•°æ®æ›´åŠ é«˜æ•ˆçš„å†…ç½®çš„æ•°æ®æ‹‰å–æœºåˆ¶ã€‚

å¦‚æœä½ ä¸ç”¨æ¡†æ¶ï¼Œä½†æ˜¯å¸Œæœ› Effects ä¸­çš„æ•°æ®æ‹‰å–æ›´åŠ ç¬¦åˆäººç±»ç›´è§‰ï¼Œè€ƒè™‘å°†ä½ çš„æ•°æ®æ‹‰å–é€»è¾‘æå–åˆ°è‡ªå®šä¹‰ Hook ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```javascript
function SearchResults({ query }) {
  const [page, setPage] = useState(1);
  const params = new URLSearchParams({ query, page });
  const results = useData(`/api/search?${params}`);

  function handleNextPageClick() {
    setPage(page + 1);
  }
  // ...
}

function useData(url) {
  const [data, setData] = useState(null);
  useEffect(() => {
    let ignore = false;
    fetch(url)
      .then(response => response.json())
      .then(json => {
        if (!ignore) {
          setData(json);
        }
      });
    return () => {
      ignore = true;
    };
  }, [url]);
  return data;
}
```

ä½ å¯èƒ½è¿˜æƒ³æ·»åŠ ä¸€äº›é€»è¾‘æ¥å¤„ç†é”™è¯¯å¹¶è¿½è¸ªå†…å®¹æ˜¯å¦æ­£åœ¨åŠ è½½ä¸­ï¼Œä½ å¯ä»¥è‡ªå·±æ„å»ºè¿™æ ·çš„ Hookï¼Œæˆ–è€…ä½¿ç”¨ React ç³»ç»Ÿä¸­å·²ç»å­˜åœ¨çš„é‚£äº›è§£å†³æ–¹æ¡ˆã€‚è™½ç„¶å•ç‹¬è¿™æ ·åšä¸å¦‚ä½¿ç”¨æ¡†æ¶å†…ç½®çš„æ•°æ®è·å–æœºåˆ¶é‚£ä¹ˆé«˜æ•ˆï¼Œä½†æ˜¯å°†æ•°æ®è·å–é€»è¾‘ç§»åŠ¨åˆ°è‡ªå®šä¹‰ Hook ä¸­å°†è®©ä»¥åæ›´å®¹æ˜“æ¥å…¥é«˜æ•ˆçš„æ•°æ®è·å–ç­–ç•¥ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œå½“ä½ å¿…é¡»ä½¿ç”¨ Effect æ—¶ï¼Œå§‹ç»ˆç•™æ„èƒ½å¦å°†æŸé¡¹åŠŸèƒ½æå–åˆ°ä¸€ä¸ªè‡ªå®šä¹‰çš„ Hook ä¸­ï¼Œå¹¶ä¸ºå…¶ä½¿ç”¨ä¸€ä¸ªæ›´å…·å£°æ˜æ€§å’Œç›®çš„æ€§çš„åå­—ï¼Œæ¯”å¦‚ä¸Šé¢çš„ `useData`ã€‚ç»„ä»¶ä¸­åŸå§‹çš„ `useEffect` è°ƒç”¨è¶Šå°‘ï¼Œç»´æŠ¤ä½ çš„åº”ç”¨ç¨‹åºå°±è¶Šå®¹æ˜“ã€‚

## å›é¡¾

- å¦‚æœä½ èƒ½åœ¨æ¸²æŸ“æ—¶è®¡ç®—å‡ºç»“æœï¼Œé‚£å°±åˆ«ç”¨ Effect
- è¦ç¼“å­˜æ˜‚è´µçš„è®¡ç®—ï¼Œä½¿ç”¨ `useMemo` è€Œä¸æ˜¯ `useEffect`
- è¦é‡ç½®ç»„ä»¶çš„æ‰€æœ‰ stateï¼Œä¼ é€’ä¸€ä¸ªä¸åŒçš„ key
- è¦é‡ç½®ç»„ä»¶çš„éƒ¨åˆ† state ä»¥å›åº” prop å˜åŒ–ï¼Œåœ¨æ¸²æŸ“æœŸé—´ç›´æ¥ set
- å› ä¸ºç»„ä»¶æ˜¾ç¤ºè€Œè¿è¡Œçš„ä»£ç åº”è¯¥åœ¨ Effect ä¸­ï¼Œå…¶ä½™çš„åœ¨äº‹ä»¶ä¸­
- è¦æ›´æ–°å¤šä¸ªç»„ä»¶çš„ stateï¼Œæœ€å¥½åœ¨ä¸€ä¸ªäº‹ä»¶ä¸­å®Œæˆ
- æ— è®ºä½•æ—¶ä½ æƒ³åœ¨å¤šä¸ªç»„ä»¶ä¸­åŒæ­¥ stateï¼Œè€ƒè™‘æå‡ state
- ä½ å¯ä»¥åœ¨ Effec ä¸­æ‹‰å–æ•°æ®ï¼Œä½†æ˜¯æœ€å¥½å®ç°ä¸€ä¸ªæ¸…ç†å‡½æ•°æ¥é¿å…ç«æ€

