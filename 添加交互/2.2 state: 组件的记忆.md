# stae: 组件的记忆

组件在用户交互的过程中常常需要变化，输入表单往往要变更输入框，点击 next 按钮需要变更当前显示图片，点击购买按钮要在购物车中加入产品。组件需要记住一些东西： 当前输入的值，当前展示的图片，购物车等。在 React中，这种特殊的组件记忆叫 state

> 你将学到:  
> - 如何通过 useState 添加一个state 变量
> - useState 返回的一组值
> - 如何添加更多的 state
> - 为什么 state 是本地的

## 常规变量不满足的时候

下面是一个渲染图片的组件，点击 next 按钮会把 index 从 1 修改为 2，从而展示下一个图片；但是无效。  

```javascript
import {imageList} from './data.js'
export default function Gallery() {
	let index = 0;
	function handleClick() {
		index = index + 1;
	}
	let image = imageList[index];
	return (
		<>
			<button onClick={handleClick}>next</button>
			<img src={image.url} />
		</>
	)
}
```

handleClick 事件处理函数会修改局部变量： index，但是被以下 2 个东西阻止了:

1. 局部变量在多次渲染时不是持久化的，当 React 第二次渲染这个组件时，它的渲染是从头开始的 —— 并不会考虑到局部变量的变化
2. 修改局部变量并不会触发渲染。 React 意识不到它需要再次渲染组件。

为了用新数据再次渲染组件，这里要做两件事：

1. 在多次渲染时持久化数据
2. 数据变更时触发 React 重新渲染组件

useState 提供了以上 2 个东西

1. 一个在多次渲染时持久化的 state
2. 一个 state 的变更函数，调用时会触发 React 再次渲染组件；

## 添加 state 变量

为了添加 state 变量， 首先在文件顶部引入 useState；

```
import {useState} from 'react';
```

然后替换这一行代码:

```javascript
// let index = 0;
const [index, setIndex] = useState(0)
```

这里 index 是 state 变量，setIndex 是状态变更函数;

> 这里的语法是数组结构，允许你从数组中读取两个值，useState 返回值有两项；  

下面是个他们一起工作的例子:  

```javascript
function handleClick() {
	setIndex(index + 1);
}
```

结合上面的代码就会工作；

### 第一个 hook

在 React 中, useState，和其他的 use 开头的函数一样，被叫做 Hook.  
Hooks 是一种特殊的函数，只有 React 在 渲染的过程中可用，它允许你 hook into React的不同特性中；  
state 其中的一个特性，随后你会遇到其他的 hooks  

> 易错点:  
> hoos 只能在你组件内部的顶级作用域内或你自己的hooks内使用， 你不能在条件、循环或其他嵌套函数中使用。Hooks 是函数，但是你可以把他们认为是你组件内部的非条件式声明，在组件内部顶级作用域内声明 hooks 和在文件顶部引用其他文件是类似的

### useState的解析

当你调用 useState，你在告诉 React 你需要这个组件记住东西：

```javascript
// 这种命名是一种约定，有助于你理解其他项目，你也可以按你的习惯来命名
const [index, setIndex] = useState(0)
```

在这里例子中，你需要 React 记住index.  

useState 只有一个参数，那就是你的状态变量的初始值，在这个例子中，index的初始值是0.  

每次你的组件渲染时，useState 会给你一个长度为2的数组：

1. 你存储的 state 变量(index)
2. state 设置函数，你可以通过它更新 state 变量，并触发 React 的再次渲染

下面是工作过程:

```javascript
const [index, setIndex] = useState(0)
```

1. 组件初次渲染： 因为你传了 0 作为 index 的初始值，它会返回 [0, setIndex]。 React 记录 0 作为上一次的 state值
2. 更新state时： 当用户点击 button，调用了 setIndex(index + 1), index 是0，所以 setIndex(1).这告诉 React 记录 index此时为1，并触发了下一次渲染。
3. 组件的二次渲染： React 看到 useState(0)，但是 React 记录了你上次设置 index 为 1， 它返回了 [1, setIndex]
4. and so on!

## 给组件多个 state 变量

你可以给一个组件任意类型和数量的 state。  

像上面的例子一样，当组件的 state 没有关联性时给他们多个state 变量是个好主意。但是当你发现你经常需要一次修改两个state时，或许把他们组合成一个会更好。举个例子，如果你有一个很多字段的表单，一个整体的对象 state 变量会比每个字段一个 state 更加方便。后面会再次讨论这个点。

> 深度阅读  
> 获取你会发现 useState 在调用时并没有获取具体的哪个 state 信息， 并没有一个类似 id 表示的东西，所以它是怎么知道如何返回哪个 state 的?  
> 为了让 state 的调用变得简洁， Hooks是依赖 component 在 render 时的稳定调用顺序的，当你遵循 hooks 规范时效果很好，hooks总会按固定的顺序调用。此外，一个风格检测的插件会捕获多数错误。 
> 在内部， React 会为每个组件持有一个 state pair 数组，同时维护了一个index，在渲染前是0；当你每次调用useState时，React给你下一个state pair并增加索引。更多内容参考 [https://medium.com/@ryardley/react-hooks-not-magic-just-arrays-cd4f1857236e](React Hooks: Not Magic Just Arrays);
> 下面的例子没有使用 React,但它让你了解useState的内部工作原理

```javascript
let componentHooks = [];
let currentHookIndex = 0;
function useState(initialState) {
	let pair  = componentHooks[currentHookIndex];
	// 非首次渲染, state pair已经存在， 直接返回即可
	if (pair) {
		currentHookIndex++;
		return pair;
	}
	// 首次渲染时，创建state pair并存下来
	pair = [initialState, setState]
	
	function setState(nextState) {
		pair[0] = nextState;
		updateDOM()
	}
	
	// 为了未来的渲染存储这段数据，并为下一次hook调用做准备
	componentHooks[currentHookIndex] = pair;
	currentHookIndex++;
	return pair;
}
```

## state 是私有和独立的

对屏幕上的组件来说state是独有的，换句话说，如果你渲染一个组件2次，每个拷贝都有完全独立的 state，改变一个并不会影响另一个；  

这正是 state 和其他你可能声明在模块顶部的变量不同的地方，state 并不与某个特定的函数调用或代码中某个地方相联系，但它是屏幕上某个特定位置独有的，你渲染了2个gallery组件，所以他们的状态被分开存储了  
同时注意到 Page 组件并不知道 Gallery 组件的 sate，甚至不知道它是否有state。与 props 不同的是，state对声明它的组件来说是完全私有的，父组件无法修改它，这可以让你在不影响其他组件的情况下方便的为组件添加或移除 state  
如果你想在多个 Gallery 组件中同步state呢？在 React 中正确的打开方式是在子组件中移除 state，然后添加到他们最近的公共父组件中。接下来的几个章节将专注于单个组件的状态管理，但我们将在 共享状态组件章节中继续讨论这个主题;

## 回顾

- 当组件在多次渲染时需要'记住'一些信息的时候， 可以使用 state
- state 变量通过调用 useState Hook 声明的；
- Hooks 和 imports有点相似：他们不能在条件分支中调用；调用 hooks，包括useState，只有在一个组件或另一个 Hook的顶层是有效的。
- useState hooks返回了一组值：state 的当前值和更新函数
- 你可以声明多个 state，React内部是通过声明顺序进行匹配的
- state 是组件私有的，如果你在多个地方渲染同一个组件，每个组件都会有自己的 state

