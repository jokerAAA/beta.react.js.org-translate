# Render 和 Commit

当你的组件显示到屏幕前，他们必须被 React 渲染。理解这个过程中的步骤有助于你思考你的代码是如何执行并解释它的行为  

> 你将学到: 
> - 渲染在 React 中的含义
> - 什么时候和为什么 React 会渲染一个组件
> - 在项目上显示一个组件的相关步骤
> - 为什么渲染并不总是产生 DOM 更新

想象一下你的组件是厨房里的厨师，用食材组装出美味的食物，React 是服务员，负责把顾客的需求带给你，这个请求和提供用户界面的过程可以分为三个步骤：  

- 触发渲染(把顾客的点餐送达厨房)
- 组件渲染(在厨房准备订单)
- 更新 DOM(将点的餐放在顾客桌上)

## 步骤1： 触发渲染

组件渲染一般有2个原因：  

1. 首次渲染
2. 组件(或某个祖先组件) state 被更新了

### 首次渲染 

当你的应用程序启动时，你需要触发首次渲染。框架和沙箱有时会隐藏这部分代码，在浏览器中一般时通过调用 `createRoot` 来完成的，随后它会调用你的组件的 `render` 方法。

### state 更新时的再次渲染

一旦组件首次渲染后，你可以通过 set 函数的方式来设置 state，从而触发再次渲染。更新你的组件的 state 会自动产生一个渲染队列，你可以把这些想象成餐厅的客人在点餐结束后会根据是否吃饱喝足来继续点餐

## 步骤2： React 渲染组件

当你触发渲染后，React 调用了你的组件。“渲染”是 React 在调用你的组件:

1. 首次渲染时, React 会调用根组件
2. 对于后续的渲染，React 会调用那些那些状态更新触发了再次渲染的组件

这个过程是递归的：如果更新的组件返回了其他的组件，React 下一步将渲染这个组件，如果这个组件也返回了组件，React 会继续渲染。这个过程直到没有递归组件且 React 知道屏幕上该显示什么时才会终止。  

在下面的例子中，React 将多次调用 `Gallery()` 和 `Image()`

```javascript
export default function Gallery() {
	return (
		<section>
			<h1>some title</h1>
			<Image />
			<Image />
			<Image />
		</section>
	)
}

function Image() {
	return (
		<img src="some src" alt="some info" />
	)
}
```

- 在首次渲染时，React 会为 section、h1、img 标签创造 html 标签。
- 在重新渲染时，React 会计算出从在上次渲染后那些些属性发生了变化(如果有的话)。它不会对这些信息做任何事直到下一步 —— 提交阶段

> 易错点
> 渲染必须是个纯计算: 
> - 相同输入，相同输出。给定输入的情况下，一个组件应该总是返回相同的 JSX。
> - 只管自己的事：它不应该改变渲染前存在的任何对象和变量(一个订单不应该修改其他人的订单)
> 否则，当你的代码变得复杂时你会遇到令人困惑的 bug 和难以预测的行为。当在严格模式下开发时，React 会对每个组件调用两次，这有助于更早的暴露非纯函数造成的错误

> 深度阅读
> 优化性能
> 当更新的组件位于 DOM 树顶层时，渲染每个嵌套组件的默认行为对性能来说不太理想，如果你遇到了性能问题，在性能章节有集中解决他们的方式，不要过早优化性能！

## 步骤三：提交更新到 DOM

在渲染你的组件后， React 会修改 DOM

- 对于首次渲染：React 会通过 appendChild 的 DOM API 把每个创建的 DOM 节点显示在屏幕上
- 对于重新渲染：React 将应用最小的必要操作(在渲染阶段计算的)以使 DOM 和最近一次的渲染结果匹配

React 只会修改那些在渲染阶段有变化的 DOM 节点，下面是个例子：

```javascript
export default function Clock({ time }) {
	return (
		<>
			<h1>{time}</h1>
			<input />
		</>
	)
}
```

因为在上一步中，React 只会更新 `H1` 标签的内容，它看到 `input` 标签中内容在两次渲染时没有变化，所以 React 不会修改 `input` 标签内容。

## 后记： 浏览器绘制

当渲染结束且 React 更新 DOM 后，浏览器会重绘。虽然这个过程普遍被叫做浏览器渲染，我们为了避免混乱会在接下来的文档中称之为绘制

## 回顾

- 在 React 应用中，任何屏幕更新都会发生以下三个步骤：  
  - trigger
  - render
  - commit
- 你可以通过使用严格模式来发现组件的错误
- 如果渲染结果和上次一样，React 不会进行 DOM 操作；
