# 更新 state 中的数组

在 javascript 中数组是可变的，但是你应该始终将 state 中的数组视为不可变的。和对象类似的是，当你想更新 state 中的数组时，你需要创造一个新的，随后 set state 来使用新数组.

> 你将学到:
> - 如何添加、删除和修改 React state 中的数组
> - 如何对数组内的对象进行更新
> - 如何通过 Immer 的放来使数组拷贝的代码更简洁

## 不要直接修改数据

在 Javascript中，数组是另一种类型的对象，和对象一样的是，应该始终视数组为只读的。这意味着你不能像 `arr[0] = 1` 一样直接为数组项赋值，且你不能使用那些修改原数组的方法，比如 `push`、`pop` 等  

每次你想更新一个数组，你需要给 setting 函数传递一个新数组。你可以从原数组中通过 `filter`、`map` 等方法创建一个新数组来实现这一点，然后你就能通过新数组来设置 state 了。  

这里是一些常见数组操作的引用表，当你在处理 React state 中的数组时，你需要避免左侧方法的使用，优先先用右侧的方法  
NOTE: 这里的 7 个方法也是 Vue 中劫持的 7 个方法，区别在于这 7 个会修改原数组，所以 Vue 劫持，触发更新；React不能修改，所以避免使用.

|      |          不推荐          |            推荐 |
| :--- | :----------------------: | --------------: |
| 添加 |       push/unshift       | concat/[...arr] |
| 删除 |     pop/shift/splice     |    filter/slice |
| 修改 | splice/arr[i] = 'newVal' |             map |
| 排序 |       reverse/sort       |          先拷贝 |

另外，你可以通过使用 Immer 的方式来使用两边的方法. 

> 易错点:
> 
> `slice` 和 `splice` 是两个长得像但是区别很大的方法:
>
> - `slice` 允许你拷贝一个数组或其中的一部分
> - `splice` 直接修改数组(插入或删除项)
>
> 在 React 中，你会更多的使用 `slice` 而不是 `splice` 以避免直接修改了 state 中的对象或数组。

### 添加

`push` 会直接修改数组，所以不要使用.  

相反的，创造一个包含之前数据的数组并把新数据添加到最后，有很多种方式可以做到这个，但是最容易的是用展开运算符的方式.  

展开运算符同样允许你将新数据添加到开始位置。  

通过这种方式，展开运算符能同时实现 `push` 和 `unshift` 的功能.

### 删除

从数据中删除数据最容易的方式是过滤，换句话来说，你会创造一个不包含指定 `item` 的新数组，使用 `filter` 方法可以帮你完成这点.  

### 修改

如果你项修改部分或全部的数组项，你可以使用 `map` 来创造一个新数组，你传递给 `map` 的函数会决定对每一项做什么，基于每一项的数据或索引。  

### 替换

用 `map`

### 插入

用 `slice`: `const index = 1;const newArr = [...arr.slice(0,index), newItem, ...arr.slice(index)]`;

### 其他修改

这里说的是排序、反转等，这种场景先拷贝数组，然后修改即可。 

即使通过展开运算符拷贝了数组，你也不能直接修改数组，因为这种拷贝是浅拷贝！！

## 修改数组内的对象

对象并不是真的在数组内部，尽管他们看起来像这样，但是数组中的每个对象都是单独的值。这就是为什么当你需要修改嵌套字段比如 `list[0]` 时需要非常小心的原因，其他人或许正在使用相同的对象.

你可以使用拷贝的方式。

你可以使用 `map` 的方式。 

通常来说，你应该只修改自己创建的对象。对于 state 中已经存在的对象，需要先拷贝一份再操作。

### 通过 Immer 来让代码简洁

通过不直接修改的方式更新数组会让代码变得冗余，就像和对象一样:

- 通常来说看，你不用更新层级太深的对象，如果你的 state 对象非常深，或许你应该考虑重构让它变得扁平。
- 如果你不想改变 state 的结构，你需要使用 Immer，它支持直接修改并为你创建一个拷贝.  

在这些场景后， Immer 会根据你对 `draft` 的改动构建出新 state，这能让你的事件回调函数非常简洁.

## 回顾

- 你可以在 state 中持有数组，但是不能修改
- 创建一个新版本的数组并 setState，而不是直接修改数组
- 你可以通过扩展运算符的方式来创建一个包含新项的数组
- 你可以使用 `fitler` 和 `map` 来创建一个包含过滤、变换项的数组
- 你可以通过使用 Immer 的方式来让代码简洁
